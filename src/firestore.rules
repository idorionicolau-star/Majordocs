
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funções de Ajuda ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // O Super Admin tem acesso total, UID codificado para controlo máximo.
      // SUBSTITUA "COLOQUE_O_SEU_UID_AQUI" PELO ID DO SEU UTILIZADOR ADMIN.
      return request.auth.uid == "COLOQUE_O_SEU_UID_AQUI";
    }
    
    function getUserData() {
      // Busca os dados do funcionário logado a partir do seu companyId no token.
      return get(/databases/$(database)/documents/companies/$(request.auth.token.companyId)/employees/$(request.auth.uid)).data;
    }

    function isEmployeeOf(companyId) {
      // O utilizador pertence à empresa se o companyId no token corresponder ou se for Super Admin.
      return isSignedIn() && (request.auth.token.companyId == companyId || isSuperAdmin());
    }
    
    function isAdminOf(companyId) {
      // É admin da empresa se pertencer a ela e a sua role for 'Admin' ou se for Super Admin.
      return isEmployeeOf(companyId) && (getUserData().role == 'Admin' || isSuperAdmin());
    }
    
    // Função can() refatorada para suportar a estrutura de objeto de permissões
    function can(module, level) {
      // O Super Admin tem acesso total a tudo.
      if (isSuperAdmin()) {
        return true;
      }
      
      // Se não for Super Admin, precisa de ter um token de empresa.
      if (!isEmployeeOf(request.auth.token.companyId)) {
        return false;
      }
      
      // O Admin da empresa tem acesso de escrita a todos os módulos da sua empresa.
      if (isAdminOf(request.auth.token.companyId)) {
        // Apenas Super Admin pode listar/ver todas as empresas.
        if (module == 'companies') return false;
        return true;
      }
      
      // Para funcionários normais, verifica as permissões granulares no objeto 'permissions'.
      let userPermissions = getUserData().permissions;
      let permissionLevel = userPermissions[module];

      if (level == 'write') {
        // Acesso de escrita SÓ é permitido se a permissão for explicitamente 'write'.
        return permissionLevel == 'write';
      }
      if (level == 'read') {
        // Acesso de leitura é permitido se a permissão for 'read' OU 'write'.
        return permissionLevel == 'read' || permissionLevel == 'write';
      }
      
      return false;
    }

    // --- Regras por Coleção ---

    // A coleção 'companies' só pode ser listada pelo Super Admin.
    // Admins de empresa podem ler os dados da sua própria empresa.
    match /companies/{companyId} {
      allow create: if true; // Qualquer pessoa pode registar uma nova empresa.
      allow get: if isEmployeeOf(companyId);
      allow list: if isSuperAdmin();
      allow update, delete: if isAdminOf(companyId);

      // Regras para as subcoleções de cada empresa.
      // O acesso é sempre verificado pela função can(módulo, nível).
      match /employees/{employeeId} {
        // Apenas admins podem gerir funcionários.
        allow get, list: if can('users', 'read');
        allow create, update, delete: if can('users', 'write');
      }
      
      match /catalogProducts/{productId} {
          allow get, list: if can('settings', 'read');
          allow create, update, delete: if can('settings', 'write');
      }
      
      match /catalogCategories/{categoryId} {
          allow get, list: if can('settings', 'read');
          allow create, update, delete: if can('settings', 'write');
      }
      
      match /products/{productId} {
        allow get, list: if can('inventory', 'read');
        allow create, update, delete: if can('inventory', 'write');
      }
      
      match /sales/{saleId} {
        allow get, list: if can('sales', 'read');
        allow create, update, delete: if can('sales', 'write');
      }
      
      match /productions/{productionId} {
        allow get, list: if can('production', 'read');
        allow create, update, delete: if can('production', 'write');
      }
      
      match /orders/{orderId} {
        allow get, list: if can('orders', 'read');
        allow create, update, delete: if can('orders', 'write');
      }
      
      match /reports/{reportId} {
        // Relatórios são tipicamente apenas de leitura para a maioria dos papéis.
        allow get, list: if can('reports', 'read');
        allow create, update, delete: if can('reports', 'write');
      }
    }
  }
}

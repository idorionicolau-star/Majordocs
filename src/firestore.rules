
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funções de Ajuda ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // SUBSTITUA "COLOQUE_O_SEU_UID_AQUI" PELO ID DO SEU UTILIZADOR ADMIN.
      return request.auth.uid == "COLOQUE_O_SEU_UID_AQUI";
    }
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/companies/$(request.auth.token.companyId)/employees/$(userId)).data;
    }

    function isEmployeeOf(companyId) {
      return isSignedIn() && (request.auth.token.companyId == companyId || isSuperAdmin());
    }
    
    function isAdminOf(companyId) {
      return isEmployeeOf(companyId) && (getUserData(request.auth.uid).role == 'Admin' || isSuperAdmin());
    }
    
    function can(module, level) {
      // O Super Admin tem acesso total.
      if (isSuperAdmin()) {
        return true;
      }
      // O Admin da empresa tem acesso de escrita a tudo.
      if (isAdminOf(request.auth.token.companyId)) {
        return true;
      }
      // Verifica as permissões do funcionário
      let userPermissions = getUserData(request.auth.uid).permissions;
      if (level == 'write') {
        return userPermissions[module] == 'write';
      }
      if (level == 'read') {
        return userPermissions[module] == 'read' || userPermissions[module] == 'write';
      }
      return false;
    }

    // --- Regras por Coleção ---

    match /companies/{companyId} {
      allow create: if true;
      allow read, update, delete: if isEmployeeOf(companyId) && isAdminOf(companyId);
      allow list: if isSuperAdmin();

      match /employees/{employeeId} {
        allow get, list: if isEmployeeOf(companyId);
        allow create, update, delete: if isEmployeeOf(companyId) && isAdminOf(companyId);
      }
      
      match /catalogProducts/{productId} {
          allow read: if can('settings', 'read');
          allow write: if can('settings', 'write');
      }
      match /catalogCategories/{categoryId} {
          allow read: if can('settings', 'read');
          allow write: if can('settings', 'write');
      }
      match /products/{productId} {
        allow read: if can('inventory', 'read');
        allow write: if can('inventory', 'write');
      }
      match /sales/{saleId} {
        allow read: if can('sales', 'read');
        allow write: if can('sales', 'write');
      }
      match /productions/{productionId} {
        allow read: if can('production', 'read');
        allow write: if can('production', 'write');
      }
      match /orders/{orderId} {
        allow read: if can('orders', 'read');
        allow write: if can('orders', 'write');
      }
      match /reports/{reportId} {
        allow read: if can('reports', 'read');
        allow write: if can('reports', 'write');
      }
       match /users/{userId} {
        allow read: if can('users', 'read');
        allow write: if can('users', 'write');
      }
    }
  }
}

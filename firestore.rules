
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles and ownership
    function isSignedIn() {
      return request.auth != null;
    }

    function isEmployee(companyId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }
    
    function isAdmin(companyId) {
       return isEmployee(companyId) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Rules for the users collection
    match /users/{userId} {
      // A user can be created by anyone (for registration)
      allow create: if true;
      // A user can read/update their own profile
      allow read, update: if isSignedIn() && request.auth.uid == userId;
      // Only an Admin of the same company can delete an employee's account
      allow delete: if isSignedIn() && isAdmin(get(/databases/$(database)/documents/users/$(userId)).data.companyId);
    }
    
    // Rules for the companies collection
    match /companies/{companyId} {
        // Anyone can create a company (initial setup)
        allow create: if isSignedIn();
        // Only employees of the company can read company details
        allow read: if isEmployee(companyId);
        // Only the admin of the company can update its details
        allow update: if isAdmin(companyId);
    }

    // Rules for all subcollections within a company document
    match /companies/{companyId}/{collection}/{docId} {
      // Any employee of the company can read, create, update, or delete data within their company's collections
      allow read, write: if isEmployee(companyId);
    }
  }
}
